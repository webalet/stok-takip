<!DOCTYPE html>
<html lang="tr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Favori Lazer - Stok Takibi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="/">
                <img src="https://lh3.googleusercontent.com/p/AF1QipNCZVPwRH5-1LxUM9Ga4EgCBfiNGliIDQ3xzYHS=s680-w680-h510" alt="Favori Lazer Logo">
                <span>Favori Lazer</span>
            </a>
            <div class="navbar-nav-buttons">
                <a href="/" class="btn btn-light">
                    <i class="fas fa-boxes me-1"></i>Stok
                </a>
                <a href="/fire-sac" class="btn btn-outline-light">
                    <i class="fas fa-recycle me-1"></i>Fire
                </a>
                <a href="{{ url_for('logout') }}" class="btn btn-danger" onclick="return confirm('Çıkış yapmak istediğinizden emin misiniz?')">
                    <i class="fas fa-sign-out-alt me-1"></i>Çıkış
                </a>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- İstatistik Kartlar -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-layer-group"></i>
                    <h3>{{ stoklar|length }}</h3>
                    <p class="mb-0">Toplam Sac Çeşidi</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-boxes"></i>
                    <h3>{{ stoklar|sum(attribute='adet') }}</h3>
                    <p class="mb-0">Toplam Plaka</p>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stats-card">
                    <i class="fas fa-clock"></i>
                    <h3>{{ stoklar|selectattr('adet', '<', 5)|list|length }}</h3>
                    <p class="mb-0">Kritik Stok Sayısı</p>
                </div>
            </div>
        </div>

        <!-- Stok Ekleme Kartı -->
        <div class="card stok-ekle-card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-plus-circle"></i>
                    <span>Yeni Stok Ekle</span>
                </h5>
            </div>
            <div class="card-body">
                <form id="stokEkleForm" onsubmit="stokEkle(event)">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <div class="input-group-custom">
                                <label for="kalinlik" class="form-label">Kalınlık (mm)</label>
                                <input type="number" step="0.1" class="form-control custom-input" id="kalinlik" name="kalinlik" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="input-group-custom">
                                <label for="tur" class="form-label">Tür</label>
                                <div class="select-wrapper">
                                    <select class="form-select" id="tur" name="tur" required>
                                        {% for tur in turler %}
                                        <option value="{{ tur.ad }}">{{ tur.ad }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="tur-ayar-btn-wrapper">
                                        <button type="button" class="btn btn-sm tur-ayar-btn" onclick="showTurModal()" title="Tür Ayarları">
                                            <i class="fas fa-cog"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="input-group-custom">
                                <label for="adet" class="form-label">Adet</label>
                                <input type="number" class="form-control custom-input" id="adet" name="adet" required min="1">
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="input-group-custom">
                                <label for="ozelOlcu" class="form-label">Özel Ölçü</label>
                                <div class="custom-switch-wrapper">
                                    <label class="switch-label">
                                        <input type="checkbox" id="ozelOlcu" name="ozelOlcu">
                                        <span class="switch-slider"></span>
                                    </label>
                                    <small class="text-muted">1500x3000</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row g-3" id="olcuAlanlari" style="display: none;">
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label for="uzunluk" class="form-label">Uzunluk (mm)</label>
                                <input type="number" class="form-control custom-input" id="uzunluk" name="uzunluk">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="input-group-custom">
                                <label for="genislik" class="form-label">Genişlik (mm)</label>
                                <input type="number" class="form-control custom-input" id="genislik" name="genislik">
                            </div>
                        </div>
                    </div>

                    <div class="text-end">
                        <button type="submit" class="btn btn-primary stok-ekle-btn">
                            <i class="fas fa-plus-circle me-2"></i>Stok Ekle
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Masaustü görünüm -->
        <div class="d-none d-md-block">
            <div class="table-responsive">
                <table class="table table-hover" id="stokTable">
                    <thead class="table-light">
                        <tr>
                            <th data-sort="kalinlik">Kalınlık (mm) <i class="fas fa-sort ms-1"></i></th>
                            <th data-sort="tur">Tür <i class="fas fa-sort ms-1"></i></th>
                            <th data-sort="uzunluk">Uzunluk (mm) <i class="fas fa-sort ms-1"></i></th>
                            <th data-sort="genislik">Genişlik (mm) <i class="fas fa-sort ms-1"></i></th>
                            <th data-sort="adet">Adet <i class="fas fa-sort ms-1"></i></th>
                            <th data-sort="tarih">Son Güncelleme <i class="fas fa-sort ms-1"></i></th>
                            <th class="islemler-header">İşlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stok in stoklar %}
                        <tr data-stock-id="{{ stok.id }}" {% if stok.adet < 5 %}class="kritik-stok"{% endif %}>
                            <td>{{ stok.kalinlik }}</td>
                            <td>{{ stok.tur }}</td>
                            <td>{{ stok.uzunluk if stok.uzunluk else '-' }}</td>
                            <td>{{ stok.genislik if stok.genislik else '-' }}</td>
                            <td>{{ stok.adet }}</td>
                            <td>{{ stok.tarih.strftime('%d-%m-%Y %H:%M') }}</td>
                            <td>
                                <button onclick="showModal('{{ stok.id }}', '{{ stok.adet }}')" class="btn btn-primary btn-sm">
                                    <i class="fas fa-edit me-1"></i>Değiştir
                                </button>
                                <button onclick="stokSil('{{ stok.id }}')" class="btn btn-danger btn-sm">
                                    <i class="fas fa-trash me-1"></i>Sil
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Mobil görünüm -->
        <div class="d-md-none">
            <div class="mobile-sort-buttons">
                <div class="btn-group">
                    <button class="btn" onclick="mobilSirala('kalinlik')">
                        <i class="fas fa-sort"></i>
                        <span>Kalınlık</span>
                    </button>
                    <button class="btn" onclick="mobilSirala('tur')">
                        <i class="fas fa-sort"></i>
                        <span>Tür</span>
                    </button>
                    <button class="btn" onclick="mobilSirala('adet')">
                        <i class="fas fa-sort"></i>
                        <span>Adet</span>
                    </button>
                    <button class="btn" onclick="mobilSirala('tarih')">
                        <i class="fas fa-sort"></i>
                        <span>Tarih</span>
                    </button>
                </div>
            </div>

            <div class="mobile-cards-container">
                {% for stok in stoklar %}
                <div class="card mb-3 {% if stok.adet < 5 %}kritik-stok-card{% endif %}" 
                     data-stok-id="{{ stok.id }}"
                     data-kalinlik="{{ stok.kalinlik }}" 
                     data-tur="{{ stok.tur }}" 
                     data-adet="{{ 'yuksek' if stok.adet >= 10 else 'orta' if stok.adet >= 5 else 'kritik' }}" 
                     data-tarih="{{ stok.tarih.strftime('%Y%m%d%H%M') }}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5 class="card-title mb-0">{{ stok.kalinlik }} mm {{ stok.tur }}</h5>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <p class="mb-0"><i class="fas fa-layer-group me-2"></i>Adet: {{ stok.adet }}</p>
                                <p class="mb-0"><i class="fas fa-ruler-combined me-2"></i>{{ stok.uzunluk if stok.uzunluk else '-' }} x {{ stok.genislik if stok.genislik else '-' }} mm</p>
                                <small class="text-muted"><i class="fas fa-clock me-2"></i>{{ stok.tarih.strftime('%d.%m.%Y %H:%M') }}</small>
                            </div>
                            <div class="mobile-action-buttons">
                                <div class="btn-group">
                                    <button class="btn btn-outline-primary rounded-3"
                                            data-stok-id="{{ stok.id }}"
                                            data-stok-adet="{{ stok.adet }}"
                                            onclick="mobilStokDegistir(this.dataset.stokId, this.dataset.stokAdet)">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger rounded-3"
                                            data-stok-id="{{ stok.id }}"
                                            onclick="mobilStokSil(this.dataset.stokId)">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer mt-5 py-3">
        <div class="container text-center">
            <small class="text-muted">
                © 2024 Tüm hakları saklıdır. Tasarım: <a href="mailto:onrcm@hotmail.com" class="text-decoration-none footer-link">Onur Çam</a>
                <span class="mx-2">|</span>
                <a href="https://instagram.com/onur.cm" target="_blank" class="text-decoration-none footer-link">
                    <i class="fab fa-instagram me-1"></i>@onur.cm
                </a>
            </small>
        </div>
    </footer>

    <!-- Tür Yönetimi Modal -->
    <div id="turYonetimModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bs-body-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 500px;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Tür Yönetimi</h5>
                <button type="button" class="btn-close" onclick="hideTurModal()"></button>
            </div>
            
            <!-- Yeni Tür Ekleme -->
            <div class="mb-4">
                <div class="input-group">
                    <input type="text" class="form-control" id="yeniTurAdi" placeholder="Yeni tür adı">
                    <button class="btn btn-primary" onclick="turEkle()">
                        <i class="fas fa-plus me-1"></i>Ekle
                    </button>
                </div>
            </div>

            <!-- Mevcut T��rler Listesi -->
            <div class="list-group" id="turlerListesi">
                <!-- Türler JavaScript ile doldurulacak -->
            </div>
        </div>
    </div>

    <!-- Stok Değiştirme Modal -->
    <div id="customModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999;">
        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--bs-body-bg); padding: 20px; border-radius: 8px; width: 90%; max-width: 400px;">
            <h5>Stok Miktarını Değiştir</h5>
            <div class="mb-3">
                <label for="yeniMiktar" class="form-label">Yeni Stok Miktarı</label>
                <input type="number" class="form-control" id="yeniMiktar" min="0" required>
                <input type="hidden" id="stockId">
            </div>
            <div class="d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-secondary" onclick="hideModal()">İptal</button>
                <button type="button" class="btn btn-primary" onclick="stokDegistirOnay()">Kaydet</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // Yardımcı fonksiyonlar
        const utils = {
            // DOM element seçicileri
            getElement: (selector) => document.querySelector(selector),
            getAllElements: (selector) => document.querySelectorAll(selector),
            
            // Animasyon yardımcıları
            async animateElement(element, properties, duration = 400) {
                element.style.transition = `all ${duration}ms ease`;
                Object.assign(element.style, properties);
                return new Promise(resolve => setTimeout(resolve, duration));
            },
            
            // API istekleri
            async fetchAPI(url, options = {}) {
                try {
                    const response = await fetch(url, options);
                    if (!response.ok) {
                        throw new Error('API isteği başarısız oldu');
                    }
                    return await response.json();
                } catch (error) {
                    console.error('API Hatası:', error);
                    throw error;
                }
            },
            
            // Hata gösterimi
            showError(message) {
                return Swal.fire({
                    title: 'Hata!',
                    text: message,
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            },
            
            // Başarı gösterimi
            showSuccess(message, timer = 1500) {
                return Swal.fire({
                    title: 'Başarılı!',
                    text: message,
                    icon: 'success',
                    confirmButtonColor: '#198754',
                    timer,
                    showConfirmButton: false
                });
            },
            
            // Onay dialogu
            async showConfirm(title, text) {
                const result = await Swal.fire({
                    title,
                    text,
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Evet',
                    cancelButtonText: 'İptal'
                });
                return result.isConfirmed;
            }
        };

        // Stok işlemleri sınıfı
        class StokManager {
            constructor() {
                this.bindEvents();
            }
            
            bindEvents() {
                // Event listener'ları bir kere bağla
                document.addEventListener('DOMContentLoaded', () => {
                    this.initializeEventListeners();
                    this.loadLastSelectedType();
                });
            }

            loadLastSelectedType() {
                const turSelect = utils.getElement('#tur');
                const sonSecilenTur = localStorage.getItem('sonSecilenTur');
                
                if (sonSecilenTur && turSelect) {
                    const option = Array.from(turSelect.options).find(opt => opt.value === sonSecilenTur);
                    if (option) {
                        option.selected = true;
                    }
                }
            }
            
            initializeEventListeners() {
                // Tür değişikliği
                const turSelect = utils.getElement('#tur');
                if (turSelect) {
                    turSelect.addEventListener('change', () => {
                        localStorage.setItem('sonSecilenTur', turSelect.value);
                    });
                }
                
                // Özel ölçü kontrolü
                const ozelOlcuCheckbox = utils.getElement('#ozelOlcu');
                const olcuAlanlari = utils.getElement('#olcuAlanlari');
                if (ozelOlcuCheckbox && olcuAlanlari) {
                    ozelOlcuCheckbox.addEventListener('change', () => {
                        olcuAlanlari.style.display = ozelOlcuCheckbox.checked ? 'flex' : 'none';
                        if (!ozelOlcuCheckbox.checked) {
                            utils.getElement('#uzunluk').value = '';
                            utils.getElement('#genislik').value = '';
                        }
                    });
                }
            }
            
            async updateStock(id, miktar) {
                try {
                    const data = await utils.fetchAPI('/stok-guncelle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: `id=${id}&miktar=${miktar}`
                    });
                    
                    if (data.success) {
                        await this.updateUI(id, miktar);
                        await utils.showSuccess('Stok miktarı güncellendi');
                        await this.updateStats();
                    } else {
                        throw new Error(data.error || 'Güncelleme başarısız');
                    }
                } catch (error) {
                    utils.showError(error.message || 'Stok güncellenirken bir hata oluştu');
                }
            }
            
            async updateUI(id, miktar) {
                // Masaüstü görünümü güncelle
                const row = utils.getElement(`tr[data-stock-id="${id}"]`);
                if (row) {
                    if (miktar === 0) {
                        await this.removeElement(row);
                    } else {
                        this.updateTableRow(row, miktar);
                    }
                }
                
                // Mobil görünümü güncelle
                const card = utils.getElement(`.card[data-stok-id="${id}"]`);
                if (card) {
                    if (miktar === 0) {
                        await this.removeElement(card);
                    } else {
                        this.updateCard(card, miktar);
                    }
                }
            }
            
            async removeElement(element) {
                await utils.animateElement(element, {
                    opacity: '0',
                    transform: 'translateX(-100%)'
                });
                element.remove();
            }
            
            updateTableRow(row, miktar) {
                const adetCell = row.querySelector('td:nth-child(5)');
                const tarihCell = row.querySelector('td:nth-child(6)');
                
                if (adetCell) adetCell.textContent = miktar;
                if (tarihCell) tarihCell.textContent = new Date().toLocaleString('tr-TR');
                
                row.classList.toggle('kritik-stok', miktar < 5);
            }
            
            updateCard(card, miktar) {
                const adetText = card.querySelector('p.mb-0');
                const tarihText = card.querySelector('small.text-muted');
                
                if (adetText) {
                    adetText.innerHTML = `<i class="fas fa-layer-group me-2"></i>Adet: ${miktar}`;
                }
                
                if (tarihText) {
                    tarihText.innerHTML = `<i class="fas fa-clock me-2"></i>${new Date().toLocaleString('tr-TR')}`;
                }
                
                this.updateCardStatus(card, miktar);
            }
            
            updateCardStatus(card, miktar) {
                card.classList.remove('bg-danger', 'bg-warning', 'bg-primary', 'text-white');
                card.dataset.adet = miktar >= 10 ? 'yuksek' : miktar >= 5 ? 'orta' : 'kritik';
                
                if (miktar < 5) {
                    card.classList.add('bg-danger', 'text-white');
                } else if (miktar >= 10) {
                    card.classList.add('bg-primary', 'text-white');
                } else {
                    card.classList.add('bg-warning', 'text-white');
                }
            }
            
            async updateStats() {
                try {
                    const data = await utils.fetchAPI('/istatistikler');
                    if (data.error) throw new Error(data.error);
                    
                    const stats = {
                        'toplam_cesit': '.stats-card:nth-child(1) h3',
                        'toplam_plaka': '.stats-card:nth-child(2) h3',
                        'kritik_stok': '.stats-card:nth-child(3) h3'
                    };
                    
                    Object.entries(stats).forEach(([key, selector]) => {
                        const element = utils.getElement(selector);
                        if (element) element.textContent = data[key];
                    });
                } catch (error) {
                    console.error('İstatistik güncelleme hatası:', error);
                }
            }
        }

        // Sınıf örneğini oluştur
        const stokManager = new StokManager();

        // Global fonksiyonları güncelle
        async function stokDegistirOnay() {
            const miktar = parseInt(utils.getElement('#yeniMiktar').value);
            const id = utils.getElement('#stockId').value;
            
            if (miktar < 0) {
                await utils.showError('Stok miktarı 0 veya daha büyük olmalıdır');
                return;
            }
            
            hideModal();
            await stokManager.updateStock(id, miktar);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-bs-theme', savedTheme);
            
            // Tablo sıralama ve filtreleme
            const table = document.getElementById('stokTable');
            const headers = table.querySelectorAll('th[data-sort]');
            const tbody = table.querySelector('tbody');
            const showLowStock = document.getElementById('showLowStock');
            let currentSort = { column: null, direction: 'asc' };

            // Sıralama fonksiyonu
            function sortTable(column) {
                const rows = Array.from(tbody.querySelectorAll('tr'));
                const direction = currentSort.column === column && currentSort.direction === 'asc' ? 'desc' : 'asc';
                
                headers.forEach(header => header.classList.remove('asc', 'desc'));
                const currentHeader = document.querySelector(`th[data-sort="${column}"]`);
                currentHeader.classList.add(direction);

                rows.sort((a, b) => {
                    let aValue = a.querySelector(`td:nth-child(${Array.from(headers).findIndex(h => h.dataset.sort === column) + 1})`).textContent;
                    let bValue = b.querySelector(`td:nth-child(${Array.from(headers).findIndex(h => h.dataset.sort === column) + 1})`).textContent;

                    if (column === 'kalinlik' || column === 'adet') {
                        aValue = parseFloat(aValue);
                        bValue = parseFloat(bValue);
                    } else if (column === 'tarih') {
                        aValue = new Date(aValue.split(' ')[0].split('-').reverse().join('-'));
                        bValue = new Date(bValue.split(' ')[0].split('-').reverse().join('-'));
                    }

                    return direction === 'asc' ? 
                        (aValue > bValue ? 1 : -1) : 
                        (aValue < bValue ? 1 : -1);
                });

                currentSort = { column, direction };
                rows.forEach(row => tbody.appendChild(row));
            }

            // Sıralama için tıklama olayları
            headers.forEach(header => {
                header.addEventListener('click', () => sortTable(header.dataset.sort));
            });

            // Kritik stok kontrolü
            const rows = tbody.querySelectorAll('tr');
            rows.forEach(row => {
                const adet = parseInt(row.querySelector('td:nth-child(3)').textContent);
                const kalinlik = parseFloat(row.querySelector('td:nth-child(1)').textContent);
                const kritikSinir = kalinlik <= 5 ? 5 : 1;
                
                if (adet <= kritikSinir) {
                    row.classList.add('kritik-stok');
                }
            });

            // Stok silme onayı
            document.querySelectorAll('.sil-btn').forEach(link => {
                link.addEventListener('click', async function(e) {
                    e.preventDefault();
                    const result = await Swal.fire({
                        title: 'Emin misiniz?',
                        text: "Bu stok kaydını silmek istediğinizden emin misiniz?",
                        icon: 'warning',
                        showCancelButton: true,
                        confirmButtonColor: '#d33',
                        cancelButtonColor: '#3085d6',
                        confirmButtonText: 'Evet, sil!',
                        cancelButtonText: 'İptal'
                    });

                    if (result.isConfirmed) {
                        fetch(this.href)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    // Satırı tablodan kaldır
                                    const row = this.closest('tr');
                                    row.style.opacity = '0';
                                    setTimeout(() => {
                                        row.remove();
                                    }, 400);

                                    // İstatistikleri AJAX ile güncelle
                                    istatistikleriGuncelle();

                                    Swal.fire({
                                        title: 'Başarıl!',
                                        text: data.message,
                                        icon: 'success',
                                        confirmButtonColor: '#28a745',
                                        confirmButtonText: 'Tamam'
                                    });
                                } else {
                                    Swal.fire({
                                        title: 'Hata!',
                                        text: data.error || 'Bir hata oluştu',
                                        icon: 'error',
                                        confirmButtonColor: '#d33',
                                        confirmButtonText: 'Tamam'
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                Swal.fire({
                                    title: 'Hata!',
                                    text: 'İşlem sırasında bir hata oluştu. Lütfen tekrar deneyin.',
                                    icon: 'error',
                                    confirmButtonColor: '#d33',
                                    confirmButtonText: 'Tamam'
                                });
                            });
                    }
                });
            });

            // Özel ölçü checkbox kontrolü
            const ozelOlcuCheckbox = document.getElementById('ozelOlcu');
            const olcuAlanlari = document.getElementById('olcuAlanlari');
            const uzunlukInput = document.getElementById('uzunluk');
            const genislikInput = document.getElementById('genislik');

            ozelOlcuCheckbox.addEventListener('change', function() {
                olcuAlanlari.style.display = this.checked ? 'flex' : 'none';
                if (!this.checked) {
                    uzunlukInput.value = '';
                    genislikInput.value = '';
                }
            });
        });

        // Modal fonksiyonları
        function showModal(id, mevcutAdet) {
            document.getElementById('stockId').value = id;
            document.getElementById('yeniMiktar').value = mevcutAdet;
            document.getElementById('customModal').style.display = 'block';
            document.getElementById('yeniMiktar').focus();
            document.body.style.overflow = 'hidden';
        }

        function hideModal() {
            document.getElementById('customModal').style.display = 'none';
            document.body.style.overflow = '';
        }

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-bs-theme');
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            html.setAttribute('data-bs-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function azaltStok(id) {
            Swal.fire({
                title: 'Stok Azalt',
                text: 'Kaç adet azaltmak istiyorsunuz?',
                input: 'number',
                inputAttributes: {
                    min: 1,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'Azalt',
                cancelButtonText: 'İptal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    const miktar = parseInt(result.value);
                    if (miktar > 0) {
                        fetch('/azalt', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `id=${id}&miktar=${miktar}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                location.reload();
                            } else {
                                Swal.fire('Hata!', data.error, 'error');
                            }
                        });
                    }
                }
            });
        }

        function silStok(id) {
            Swal.fire({
                title: 'Emin misiniz?',
                text: 'Bu stok kaydnı silmek istediğinize emin misiniz?',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'Evet, Sil',
                cancelButtonText: 'İptal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/sil/${id}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            Swal.fire('Hata!', data.error, 'error');
                        }
                    });
                }
            });
        }

        // Mobil görün��m için sıralama değişkenleri
        let aktifSiralamaAlani = null;
        let aktifSiralamaYonu = 'asc';

        // Mobil görünüm için sıralama fonksiyonu
        function mobilSirala(alan) {
            // Eğer aynı alan tekrar tıklandıysa yönü değiştir, değilse yeni alana geç ve yönü sıfırla
            if (aktifSiralamaAlani === alan) {
                aktifSiralamaYonu = aktifSiralamaYonu === 'asc' ? 'desc' : 'asc';
            } else {
                aktifSiralamaAlani = alan;
                aktifSiralamaYonu = 'asc';
            }
            
            // Tüm butonların aktif sınıfını kaldır
            document.querySelectorAll('.mobile-sort-buttons .btn').forEach(button => {
                button.classList.remove('active');
                const icon = button.querySelector('i');
                if (icon) {
                    icon.style.transform = '';
                    icon.style.opacity = '0.5';
                }
            });
            
            // Tıklanan butonu aktif yap
            const activeButton = document.querySelector(`.mobile-sort-buttons .btn[onclick*="${alan}"]`);
            if (activeButton) {
                activeButton.classList.add('active');
                const icon = activeButton.querySelector('i');
                if (icon) {
                    icon.style.transform = aktifSiralamaYonu === 'desc' ? 'rotate(180deg)' : '';
                    icon.style.opacity = '1';
                }
            }

            // Kartları sırala
            const container = document.querySelector('.mobile-cards-container');
            if (!container) return;

            const cards = Array.from(container.querySelectorAll('.card'));
            
            cards.sort((a, b) => {
                let aValue, bValue;
                
                switch(alan) {
                    case 'kalinlik':
                        aValue = parseFloat(a.querySelector('.card-title')?.textContent?.match(/[\d.]+/)?.[0]) || 0;
                        bValue = parseFloat(b.querySelector('.card-title')?.textContent?.match(/[\d.]+/)?.[0]) || 0;
                        break;
                    case 'adet':
                        aValue = parseInt(a.querySelector('p.mb-0')?.textContent?.match(/\d+/)?.[0]) || 0;
                        bValue = parseInt(b.querySelector('p.mb-0')?.textContent?.match(/\d+/)?.[0]) || 0;
                        break;
                    case 'tarih':
                        aValue = a.querySelector('small')?.textContent?.trim() || '';
                        bValue = b.querySelector('small')?.textContent?.trim() || '';
                        break;
                    case 'tur':
                        aValue = a.querySelector('.card-title')?.textContent?.split('mm')?.[1]?.trim() || '';
                        bValue = b.querySelector('.card-title')?.textContent?.split('mm')?.[1]?.trim() || '';
                        break;
                    default:
                        return 0;
                }

                // Sıralama yönüne göre karşılaştır
                if (aktifSiralamaYonu === 'asc') {
                    return aValue > bValue ? 1 : -1;
                } else {
                    return aValue < bValue ? 1 : -1;
                }
            });

            // Sıralanmış kartları yerleştir
            cards.forEach(card => container.appendChild(card));
        }

        // Mobil liste güncelleme fonksiyonu
        function mobilListeyiGuncelle() {
            try {
                const container = document.querySelector('.d-md-none');
                if (!container) return;

                const buttonGroup = container.querySelector('.mobile-sort-buttons');
                if (!buttonGroup) return;

                const mobileCardsContainer = container.querySelector('.mobile-cards-container');
                if (!mobileCardsContainer) return;

                const cards = Array.from(mobileCardsContainer.querySelectorAll('.card'));
                if (!cards.length) return;

                // Kartları sırala
                if (aktifSiralamaAlani) {
                    cards.sort((a, b) => {
                        try {
                            const aContent = a.querySelector('.card-body');
                            const bContent = b.querySelector('.card-body');
                            
                            if (!aContent || !bContent) return 0;

                            let aValue, bValue;

                            switch(aktifSiralamaAlani) {
                                case 'kalinlik':
                                    aValue = parseFloat(aContent.querySelector('.card-title')?.textContent?.match(/[\d.]+/)?.[0]) || 0;
                                    bValue = parseFloat(bContent.querySelector('.card-title')?.textContent?.match(/[\d.]+/)?.[0]) || 0;
                                    break;
                                case 'adet':
                                    aValue = parseInt(aContent.querySelector('.card-text')?.textContent?.match(/\d+/)?.[0]) || 0;
                                    bValue = parseInt(bContent.querySelector('.card-text')?.textContent?.match(/\d+/)?.[0]) || 0;
                                    break;
                                case 'tarih':
                                    aValue = aContent.querySelector('small')?.textContent?.trim() || '';
                                    bValue = bContent.querySelector('small')?.textContent?.trim() || '';
                                    break;
                                case 'tur':
                                    aValue = aContent.querySelector('.card-title')?.textContent?.split('mm')?.[1]?.trim() || '';
                                    bValue = bContent.querySelector('.card-title')?.textContent?.split('mm')?.[1]?.trim() || '';
                                    break;
                                default:
                                    return 0;
                            }

                            if (aktifSiralamaYonu === 'asc') {
                                return aValue > bValue ? 1 : -1;
                            } else {
                                return aValue < bValue ? 1 : -1;
                            }
                        } catch (error) {
                            console.error('Sıralama karşılaştırma hatası:', error);
                            return 0;
                        }
                    });

                    // Sıralanmış kartları yeniden yerleştir
                    cards.forEach(card => {
                        mobileCardsContainer.appendChild(card);
                    });
                }
            } catch (error) {
                console.error('Mobil liste gncelleme hatası:', error);
            }
        }

        // Stok durumunu güncelleme fonksiyonu
        function updateMobileStockStatus() {
            try {
                const cards = document.querySelectorAll('.d-md-none .card');
                if (!cards) return;

                cards.forEach(card => {
                    const cardContent = card.querySelector('.card-body');
                    if (!cardContent) return;

                    const cardText = cardContent.querySelector('.card-text');
                    const cardTitle = cardContent.querySelector('.card-title');
                    
                    if (!cardText || !cardTitle) return;

                    const adetMatch = cardText.textContent.match(/\d+/);
                    const kalinlikMatch = cardTitle.textContent.match(/[\d.]+/);
                    
                    if (!adetMatch || !kalinlikMatch) return;

                    const adet = parseInt(adetMatch[0]) || 0;
                    const kalinlik = parseFloat(kalinlikMatch[0]) || 0;
                    const kritikSinir = kalinlik <= 5 ? 5 : 1;
                    
                    // Renk sınıflarını temizle
                    card.classList.remove('bg-danger', 'bg-warning', 'bg-primary', 'text-white');
                    
                    // Yeni renk sınıflarını ekle
                    if (adet <= kritikSinir) {
                        card.classList.add('bg-danger', 'text-white');
                    } else if (adet >= 10) {
                        card.classList.add('bg-primary', 'text-white');
                    } else {
                        card.classList.add('bg-warning', 'text-white');
                    }
                });
            } catch (error) {
                console.error('Stok durumu güncelleme hatası:', error);
            }
        }

        // Stok ekleme fonksiyonunu güncelle
        function stokEkle(event) {
            event.preventDefault();
            
            const formData = new FormData(event.target);
            const secilenTur = document.getElementById('tur').value;
            const ozelOlcu = document.getElementById('ozelOlcu').checked;
            
            // Form verilerini hazırla
            const data = {
                kalinlik: formData.get('kalinlik'),
                tur: secilenTur,
                adet: formData.get('adet'),
                uzunluk: ozelOlcu ? formData.get('uzunluk') : '1500',
                genislik: ozelOlcu ? formData.get('genislik') : '3000'
            };
            
            // Son seçilen türü kaydet
            localStorage.setItem('sonSecilenTur', secilenTur);
            
            fetch('/ekle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams(data)
            })
            .then(response => {
                if (!response.ok) {
                    return response.text().then(text => {
                        throw new Error(text || 'Stok eklenirken bir hata oluştu');
                    });
                }
                return response.text();
            })
            .then(() => {
                // Form alanlarını temizle ama tür seçimini koru
                document.getElementById('kalinlik').value = '';
                document.getElementById('adet').value = '';
                document.getElementById('ozelOlcu').checked = false;
                document.getElementById('uzunluk').value = '';
                document.getElementById('genislik').value = '';
                document.getElementById('olcuAlanlari').style.display = 'none';
                
                // Başarı mesajı göster ve sayfayı yenile
                Swal.fire({
                    icon: 'success',
                    title: 'Başarılı!',
                    text: 'Stok başarıyla eklendi',
                    showConfirmButton: false,
                    timer: 1500
                }).then(() => {
                    // Sayfayı yenilemeden önce son seçilen türü tekrar kaydet
                    const sonTur = localStorage.getItem('sonSecilenTur');
                    window.onload = function() {
                        const turSelect = document.getElementById('tur');
                        if (turSelect && sonTur) {
                            const option = Array.from(turSelect.options).find(opt => opt.value === sonTur);
                            if (option) {
                                option.selected = true;
                            }
                        }
                    };
                    location.reload();
                });
            })
            .catch(error => {
                console.error('Hata:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Hata!',
                    text: error.message
                });
            });
        }

        // Sayfa yüklendiğinde son seçilen türü seç
        document.addEventListener('DOMContentLoaded', function() {
            const turSelect = document.getElementById('tur');
            const sonSecilenTur = localStorage.getItem('sonSecilenTur');
            
            if (sonSecilenTur && turSelect) {
                const option = Array.from(turSelect.options).find(opt => opt.value === sonSecilenTur);
                if (option) {
                    option.selected = true;
                }
            }
        });

        // Tür değiştiğinde localStorage'a kaydet
        document.getElementById('tur').addEventListener('change', function() {
            localStorage.setItem('sonSecilenTur', this.value);
        });

        // Mobil görünüm için stok azaltma ve silme fonksiyonları
        function mobilStokAzalt(id) {
            Swal.fire({
                title: 'Stok Azalt',
                text: 'Kaç adet azaltmak istiyorsunuz?',
                input: 'number',
                inputAttributes: {
                    min: 1,
                    step: 1
                },
                showCancelButton: true,
                confirmButtonText: 'Azalt',
                cancelButtonText: 'İptal',
                reverseButtons: true
            }).then((result) => {
                if (result.isConfirmed) {
                    const miktar = parseInt(result.value);
                    if (miktar > 0) {
                        fetch('/azalt', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: `id=${id}&miktar=${miktar}`
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Sayfayı yenilemeden görünümü güncelle
                                fetch(window.location.href)
                                    .then(response => response.text())
                                    .then(html => {
                                        const parser = new DOMParser();
                                        const doc = parser.parseFromString(html, 'text/html');
                                        
                                        // Mobil grünümü güncelle
                                        const mobileView = doc.querySelector('.d-md-none');
                                        document.querySelector('.d-md-none').innerHTML = mobileView.innerHTML;
                                        
                                        // İstatistik kartlarını güncelle
                                        const statsCards = doc.querySelectorAll('.stats-card');
                                        document.querySelectorAll('.stats-card').forEach((card, index) => {
                                            card.innerHTML = statsCards[index].innerHTML;
                                        });

                                        // Kritik stok kontrolünü tekrar çalıştır
                                        updateMobileStockStatus();
                                    });
                            } else {
                                Swal.fire('Hata!', data.error, 'error');
                            }
                        });
                    }
                }
            });
        }

        // Mobil görünüm için silme fonksiyonu
        async function mobilStokSil(id) {
            await stokSil(id); // Ana silme fonksiyonunu kullan
        }

        // İstatistikleri güncelle
        function istatistikleriGuncelle() {
            console.log('İstatistikler güncelleniyor...');
            fetch('/istatistikler')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('İstatistikler alınamadı');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.error) {
                        console.error('İstatistik hatası:', data.error);
                        return;
                    }

                    console.log('Alınan istatistikler:', data);

                    // Toplam Sac Çeşidi
                    const toplamSacCesidi = document.querySelector('.stats-card:nth-child(1) h3');
                    if (toplamSacCesidi) {
                        toplamSacCesidi.textContent = data.toplam_cesit;
                        console.log('Toplam çeşit güncellendi:', data.toplam_cesit);
                    }

                    // Toplam Plaka
                    const toplamPlaka = document.querySelector('.stats-card:nth-child(2) h3');
                    if (toplamPlaka) {
                        toplamPlaka.textContent = data.toplam_plaka;
                        console.log('Toplam plaka gncellendi:', data.toplam_plaka);
                    }

                    // Kritik Stok Sayısı
                    const kritikStokSayisi = document.querySelector('.stats-card:nth-child(3) h3');
                    if (kritikStokSayisi) {
                        kritikStokSayisi.textContent = data.kritik_stok;
                        console.log('Kritik stok güncellendi:', data.kritik_stok);
                    }
                })
                .catch(error => {
                    console.error('İstatistikler güncellenirken hata:', error);
                });
        }

        // Stok silme fonksiyonu - Masaüstü
        async function stokSil(id) {
            try {
                const result = await Swal.fire({
                    title: 'Emin misiniz?',
                    text: "Bu stok kaydını silmek istediğinizden emin misiniz?",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Evet, sil!',
                    cancelButtonText: 'İptal'
                });

                if (result.isConfirmed) {
                    const response = await fetch(`/sil/${id}`);
                    const data = await response.json();

                    if (data.success) {
                        // Başarı mesajını göster ve kapanmasını bekle
                        await Swal.fire({
                            title: 'Başarılı!',
                            text: 'Stok başarıyla silindi',
                            icon: 'success',
                            timer: 1000,
                            showConfirmButton: false
                        });

                        // Popup kapandıktan sonra animasyonları başlat
                        // Masaüstü görünümünden satırı kaldır
                        const row = document.querySelector(`tr[data-stock-id="${id}"]`);
                        if (row) {
                            row.style.transition = 'all 0.8s ease';
                            row.style.backgroundColor = 'rgba(220, 53, 69, 0.1)';
                            
                            setTimeout(() => {
                                row.style.opacity = '0';
                                row.style.transform = 'translateX(-100%)';
                            }, 100);

                            setTimeout(() => {
                                row.style.maxHeight = '0';
                                row.style.padding = '0';
                                row.style.margin = '0';
                            }, 600);

                            setTimeout(() => row.remove(), 900);
                        }

                        // Mobil görünümünden kartı kaldır
                        const card = document.querySelector(`.card[data-stok-id="${id}"]`);
                        if (card) {
                            // Önce kartı seçili hale getir
                            card.style.transition = 'all 0.8s ease';
                            card.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.5)';
                            
                            // Silme animasyonunu başlat
                            setTimeout(() => {
                                card.style.opacity = '0';
                                card.style.transform = 'translateX(-100%) scale(0.9)';
                                card.style.marginLeft = '-20px';
                            }, 100);

                            // Animasyon bittikten sonra kartı kaldır
                            setTimeout(() => {
                                card.style.maxHeight = '0';
                                card.style.margin = '0';
                                card.style.padding = '0';
                            }, 600);

                            // En son kartı DOM'dan kaldır
                            setTimeout(() => card.remove(), 900);
                        }

                        // İstatistikleri güncelle
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        throw new Error(data.error || 'Silme işlemi başarısız');
                    }
                }
            } catch (error) {
                console.error('Silme hatası:', error);
                Swal.fire({
                    title: 'Hata!',
                    text: error.message || 'Silme işlemi sırasında bir hata oluştu',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // İstatistikleri güncelleme fonksiyonu
        async function updateStats() {
            try {
                console.log('İstatistikler güncelleniyor...');
                const response = await fetch('/istatistikler');
                
                if (!response.ok) {
                    throw new Error('İstatistikler alınamadı');
                }

                const data = await response.json();
                console.log('Alınan istatistikler:', data);

                // Toplam Sac Çeşidi
                const toplamSacCesidi = document.querySelector('.stats-card:nth-child(1) h3');
                if (toplamSacCesidi) {
                    toplamSacCesidi.textContent = data.toplam_cesit;
                    console.log('Toplam çeşit güncellendi:', data.toplam_cesit);
                }

                // Toplam Plaka
                const toplamPlaka = document.querySelector('.stats-card:nth-child(2) h3');
                if (toplamPlaka) {
                    toplamPlaka.textContent = data.toplam_plaka;
                    console.log('Toplam plaka güncellendi:', data.toplam_plaka);
                }

                // Kritik Stok Sayısı
                const kritikStokSayisi = document.querySelector('.stats-card:nth-child(3) h3');
                if (kritikStokSayisi) {
                    kritikStokSayisi.textContent = data.kritik_stok;
                    console.log('Kritik stok güncellendi:', data.kritik_stok);
                }
            } catch (error) {
                console.error('İstatistik güncelleme hatası:', error);
            }
        }

        // Mobil stok değiştirme fonksiyonu
        async function mobilStokDegistir(id, mevcutAdet) {
            try {
                const { value: yeniMiktar } = await Swal.fire({
                    title: 'Stok Miktarını Değiştir',
                    input: 'number',
                    inputLabel: 'Yeni Stok Miktarı',
                    inputValue: mevcutAdet,
                    showCancelButton: true,
                    cancelButtonText: 'İptal',
                    confirmButtonText: 'Kaydet',
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    inputValidator: (value) => {
                        if (!value) {
                            return 'Lütfen bir değer girin!';
                        }
                        if (value < 0) {
                            return 'Stok miktarı 0 veya daha büyük olmalıdır!';
                        }
                    }
                });

                if (yeniMiktar) {
                    const response = await fetch('/stok-guncelle', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `id=${id}&miktar=${yeniMiktar}`
                    });

                    const data = await response.json();

                    if (data.success) {
                        const card = document.querySelector(`.card[data-stok-id="${id}"]`);
                        if (card) {
                            if (yeniMiktar === '0') {
                                // Stok sıfırsa kartı kaldır
                                card.style.opacity = '0';
                                setTimeout(() => card.remove(), 400);
                            } else {
                                // Stok miktarını güncelle
                                const adetText = card.querySelector('p.mb-0');
                                if (adetText) {
                                    adetText.innerHTML = `<i class="fas fa-layer-group me-2"></i>Adet: ${yeniMiktar}`;
                                }
                                
                                // Tarih güncelle
                                const tarihText = card.querySelector('small.text-muted');
                                if (tarihText) {
                                    tarihText.innerHTML = `<i class="fas fa-clock me-2"></i>${new Date().toLocaleString('tr-TR')}`;
                                }

                                // Kart sınıflarını güncelle
                                card.classList.remove('kritik-stok-card');
                                card.dataset.adet = yeniMiktar >= 10 ? 'yuksek' : yeniMiktar >= 5 ? 'orta' : 'kritik';
                                if (yeniMiktar < 5) {
                                    card.classList.add('kritik-stok-card');
                                }
                            }

                            // İstatistikleri güncelle
                            istatistikleriGuncelle();
                        }

                        Swal.fire({
                            title: 'Başarılı!',
                            text: 'Stok miktarı güncellendi',
                            icon: 'success',
                            confirmButtonColor: '#198754',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    } else {
                        throw new Error(data.error || 'Güncelleme başarısız');
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Hata!',
                    text: error.message || 'Stok güncellenirken bir hata oluştu',
                    icon: 'error',
                    confirmButtonColor: '#dc3545'
                });
            }
        }

        // Tür yönetimi sınıfı
        class TurManager {
            constructor() {
                this.bindEvents();
            }
            
            bindEvents() {
                const turModal = utils.getElement('#turYonetimModal');
                if (turModal) {
                    const closeBtn = turModal.querySelector('.btn-close');
                    if (closeBtn) {
                        closeBtn.addEventListener('click', () => this.hideModal());
                    }
                }
            }
            
            showModal() {
                const modal = utils.getElement('#turYonetimModal');
                if (modal) {
                    modal.style.display = 'block';
                    document.body.style.overflow = 'hidden';
                    this.updateTurList();
                }
            }
            
            hideModal() {
                const modal = utils.getElement('#turYonetimModal');
                if (modal) {
                    modal.style.display = 'none';
                    document.body.style.overflow = '';
                }
            }
            
            async updateTurList() {
                try {
                    const turler = await utils.fetchAPI('/turler');
                    const liste = utils.getElement('#turlerListesi');
                    if (!liste) return;
                    
                    liste.innerHTML = turler.map(tur => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <span>${tur.ad}</span>
                            <button class="btn btn-danger btn-sm" onclick="turManager.deleteTur(${tur.id}, '${tur.ad}')">
                                <i class="fas fa-trash me-1"></i>Sil
                            </button>
                        </div>
                    `).join('');
                } catch (error) {
                    utils.showError('Tür listesi güncellenirken bir hata oluştu');
                }
            }
            
            async addTur() {
                const input = utils.getElement('#yeniTurAdi');
                const turAdi = input?.value.trim();
                
                if (!turAdi) {
                    await utils.showError('Tür adı boş olamaz!');
                    return;
                }
                
                try {
                    const formData = new URLSearchParams();
                    formData.append('tur_adi', turAdi);
                    
                    const data = await utils.fetchAPI('/tur/ekle', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                        body: formData
                    });
                    
                    if (data.success) {
                        if (input) input.value = '';
                        await this.updateTurList();
                        await this.updateTurSelect();
                        await utils.showSuccess('Tür başarıyla eklendi');
                    } else {
                        throw new Error(data.error);
                    }
                } catch (error) {
                    utils.showError(error.message || 'Tür eklenirken bir hata oluştu');
                }
            }
            
            async deleteTur(id, ad) {
                const confirmed = await utils.showConfirm(
                    'Emin misiniz?',
                    `"${ad}" türünü silmek istediğinizden emin misiniz?`
                );
                
                if (confirmed) {
                    try {
                        const data = await utils.fetchAPI(`/tur/sil/${id}`, { method: 'DELETE' });
                        if (data.success) {
                            await this.updateTurList();
                            await this.updateTurSelect();
                            await utils.showSuccess('Tür başarıyla silindi');
                        } else {
                            throw new Error(data.error);
                        }
                    } catch (error) {
                        utils.showError(error.message || 'Tür silinirken bir hata oluştu');
                    }
                }
            }
            
            async updateTurSelect() {
                try {
                    const turler = await utils.fetchAPI('/turler');
                    const turSelect = utils.getElement('#tur');
                    const sonSecilenTur = localStorage.getItem('sonSecilenTur');
                    
                    if (!turSelect) return;
                    
                    turSelect.innerHTML = turler.map(tur => `
                        <option value="${tur.ad}" ${tur.ad === sonSecilenTur ? 'selected' : ''}>
                            ${tur.ad}
                        </option>
                    `).join('');
                } catch (error) {
                    console.error('Tür seçimi güncellenirken hata:', error);
                }
            }
        }

        // Stok silme işlemleri sınıfı
        class StokSilManager {
            async deleteStok(id) {
                try {
                    const confirmed = await utils.showConfirm(
                        'Emin misiniz?',
                        'Bu stok kaydını silmek istediğinizden emin misiniz?'
                    );

                    if (confirmed) {
                        const data = await utils.fetchAPI(`/sil/${id}`);
                        
                        if (data.success) {
                            await this.handleSuccessfulDelete(id);
                        } else {
                            throw new Error(data.error || 'Silme işlemi başarısız');
                        }
                    }
                } catch (error) {
                    console.error('Silme hatası:', error);
                    utils.showError(error.message || 'Silme işlemi sırasında bir hata oluştu');
                }
            }

            async handleSuccessfulDelete(id) {
                await utils.showSuccess('Stok başarıyla silindi', 1000);
                
                // Masaüstü görünümünden satırı kaldır
                const row = utils.getElement(`tr[data-stock-id="${id}"]`);
                if (row) await this.animateAndRemove(row);
                
                // Mobil görünümünden kartı kaldır
                const card = utils.getElement(`.card[data-stok-id="${id}"]`);
                if (card) await this.animateAndRemove(card);
                
                // İstatistikleri güncelle
                await stokManager.updateStats();
            }

            async animateAndRemove(element) {
                await utils.animateElement(element, {
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    opacity: '0',
                    transform: 'translateX(-100%)'
                }, 800);
                
                await utils.animateElement(element, {
                    maxHeight: '0',
                    padding: '0',
                    margin: '0'
                }, 200);
                
                element.remove();
            }
        }

        // Sınıf örneklerini oluştur
        const turManager = new TurManager();
        const stokSilManager = new StokSilManager();

        // Global fonksiyonları güncelle
        function showTurModal() {
            turManager.showModal();
        }

        function hideTurModal() {
            turManager.hideModal();
        }

        function turEkle() {
            turManager.addTur();
        }

        function turSil(id, ad) {
            turManager.deleteTur(id, ad);
        }

        async function stokSil(id) {
            await stokSilManager.deleteStok(id);
        }
    </script>
</body>
</html> 